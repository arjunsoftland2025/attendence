{% extends "templates/web.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<style type="text/css">
    .navbar-light {
        display: none !important;
    }

    .chat-app {
        display: none !important;
    }

    footer {
        display: none !important;
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

{% include 'attendence/templates/includes/navbar.html' %}

<div class="container mt-3">
    <h2 class="display-6 py-2">Dashboard</h2>
    <!-- <h3 class="me-2">Name: <span id="name" class="me-2 font-italic" type="text" name="name"></span></h1> -->
    <div class="d-flex justify-content-start">
        <div class="d-flex align-items-center me-3">
            <h3 class="me-2">Name:</h3>
            <input id="name" class="form-control me-2" type="text" name="name">
        </div>
        <div class="d-flex align-items-center me-3">
            <h3 class="me-2">Date:</h3>
            <input id="date" class="form-control me-2" type="date" name="date">
        </div>
        <button class="btn btn-primary" onclick="fetchDetails()">Submit</button>
    </div>

    <div class="container">
        <table class="table table-bordered border-3 mt-3">
            <thead>
                <tr>
                    <th scope="col">Session</th>
                    <th scope="col">Check in</th>
                    <th scope="col">Check out</th>
                    <th scope="col">Working Hours</th>
                </tr>
            </thead>
            <tbody id="data">
            </tbody>
        </table>
        <table class="table table-striped  mt-3">
            <tr>
                <th>Total Working Hours</th>
                <th>Daily Average </th>
                <th>Weekly Average </th>
                <th>Monthly Average </th>
            </tr>
            <tr>
                <td><span id="total-working-hours"></span></td>
                <td><span id="daily-avg"></span></td>
                <td><span id="weekly-avg"></span></td>
                <td><span id="monthly-avg"></span></td>
            </tr>
        </table>
    </div>

    <div class="container pt-4" id="reports-table" style="display: none;">
        <div class="d-flex justify-content-between">
            <div class="d-flex align-items-center me-3">
                <h2>Reports</h2>
            </div>
            <div class="d-flex align-items-center me-3">
                <h4 class="me-2">Date:</h4>
                <input id="report-date" class="form-control me-2" type="date" name="report-date">
            </div>
        </div>
        <div class="mt-2" id="reportNames-data"></div>
    </div>
    

</div>

<script>

document.addEventListener("DOMContentLoaded", function () {
    fetchCurrentDate();
});


document.getElementById("report-date").addEventListener("change", fetchDetails);

async function fetchCurrentDate() {
    try {
        const response = await fetch('/api/method/attendence.api.get_date'); // Call the API
        const result = await response.json();
        
        if (result.message) {
            document.getElementById("date").value = result.message; // Set the date input field
            document.getElementById("report-date").value = result.message;
        }
    } catch (error) {
        console.error("Error fetching date:", error);
    }
}

async function fetchDetails() {
    try {
        const givenEmployee = document.getElementById("name").value.toUpperCase();
        const givenDate = document.getElementById("date").value;
        
        const reportDate = givenDate;
        console.log("Employee:", givenEmployee, "Date:", givenDate);

        const response = await fetch(`/api/method/attendence.api.get_attendance?employee_name=${givenEmployee}&date=${givenDate}`);
        const result = await response.json();
        console.log("employee", result);

        if (!result.message || !result.message.attendance_sessions) {
            console.error("Invalid data structure", result);
            return;
        }

        const attendanceSessions = result.message.attendance_sessions;
        console.log("attendanceSessions", attendanceSessions);
        const totalWorkingHours = result.message.working_hours;
        console.log("Total Working Hours:", totalWorkingHours);

        // Clear existing table data
        document.getElementById("data").innerHTML = "";
        document.getElementById("reportNames-data").innerHTML = "";

        // Populate attendance sessions
        attendanceSessions.forEach((sessionData, index) => {
            const sessionKey = Object.keys(sessionData)[0];
            const session = sessionData[sessionKey];

            document.getElementById("data").innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${session.in_time}</td>
                    <td>${session.out_time}</td>
                    <td>${session.working_hours}</td>
                </tr>`;
        });

        document.getElementById("total-working-hours").textContent = totalWorkingHours;

        // Calculate daily average
        const [hours, minutes] = totalWorkingHours.split(":");
        document.getElementById("daily-avg").textContent = `${hours}.${minutes.padStart(2, "0")}`;

        document.getElementById("weekly-avg").textContent = 0;
        document.getElementById("monthly-avg").textContent = 0;

        // Populate Reports Table (if report_to exist)
        const reportNames = result.message.report_names;
        console.log("report-names",reportNames);

        fetchReports(reportNames);

    } 
    catch (error) {
        console.error("Error fetching attendance data:", error);
    }
}

async function fetchReports(reportNames) {
    try {
        const reportDate = document.getElementById("report-date").value;

        console.log("Fetching reports for date:", reportDate);

        if (!reportNames || reportNames.length === 0) {
            document.getElementById("reports-table").style.display = "none";
            return;
        }

        document.getElementById("reports-table").style.display = "block";
        document.getElementById("reportNames-data").innerHTML = "";

        for (const employee of reportNames) {
            const reportEmployee = employee.employee;
            console.log("Fetching report data for:", reportEmployee);

            const response = await fetch(`/api/method/attendence.api.get_attendance?employee_name=${reportEmployee}&date=${reportDate}`);
            const reportResult = await response.json();
            console.log("sub-result",reportResult);

            if (!reportResult.message || !reportResult.message.attendance_sessions) continue;

            let sessionRows = reportResult.message.attendance_sessions.map((sessionData, index) => {
                const sessionKey = Object.keys(sessionData)[0];
                const session = sessionData[sessionKey];
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${session.in_time || "-"}</td>
                        <td>${session.out_time || "-"}</td>
                        <td>${session.working_hours || "0:00:00"}</td>
                    </tr>`;
            }).join("");

            document.getElementById("reportNames-data").innerHTML += `
                <h4>${reportEmployee}</h4>
                <table class="table table-bordered border-3 mt-3">
                    <thead>
                        <tr>
                            <th scope="col">Session</th>
                            <th scope="col">Check in</th>
                            <th scope="col">Check out</th>
                            <th scope="col">Working Hours</th>
                        </tr>
                    </thead>
                    <tbody>${sessionRows}</tbody>
                </table>`;


        }

        

    } catch (error) {
        console.error("Error fetching report data:", error);
    }
}

</script>
{% endblock %}

